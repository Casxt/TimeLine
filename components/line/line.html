<main role="main" class="container text-center mt-5 mb-5">
    <div class="card mt-3">
        <form id="AddSlice-Form" class="card-body cols container">
            <textarea class="form-control" id="Content" name="Content" rows="3"></textarea>
            <div class="row mt-2 w-auto float-md-right mr-1 ml-1">
                <div class="custom-file w-auto mr-1 mt-2">
                    <div class="btn btn-primary">
                        <input name="imgs" type="file" multiple="multiple" style="width: 6rem; opacity: 0; position: absolute; z-index: -1" id="images"
                            onchange="preview(this)">
                        <label style="width:6rem;position:relative;margin: 1px" for="images">Choose Img</label>
                    </div>
                </div>
                <select name="Type" class="form-control mr-1 ml-1 mt-2 w-auto" id="Type">
                    <option value="Memory">Memory</option>
                    <option value="Anniversary">Anniversary</option>
                </select>
                <select name="Visibility" class="form-control mr-1 ml-1 mt-2 w-auto" id="Visibility">
                    <option value="Protect">Group</option>
                    <option value="Public">All</option>
                    <option value="Private">Self</option>
                </select>
                <input id="Latitude" name="Latitude" type="hidden" value="0">
                <input id="Longitude" name="Longitude" type="hidden" value="0">
                <input id="Time" name="Time" class="form-control mr-1 ml-1 mt-2 w-auto" style="text-align: center;font-size: 0.85rem;padding: 0.4rem"
                    type="datetime-local" value="">
                <!--type="submit" width: 11.5rem;-->
                <button class="btn btn-primary ml-1 mt-2" id="AddSlice-Button" type="button" onclick="SubmitSlice()">Submit</button>
            </div>
        </form>
        <div class="container mb-3" id="preview">

        </div>
    </div>
    <div class="card mt-3">
        <div class="card-body">
            This is some text within a card body.
        </div>
    </div>
</main>
<script type="text/javascript">
    TimeInput = document.getElementById('Time');
    latitudeInput = document.getElementById('Latitude');
    longitudeInput = document.getElementById('Longitude');
    //Update Time and location
    function updateInfo() {
        const offset = new Date();
        const now = new Date(offset.getTime() - offset.getTimezoneOffset() * 60000);
        TimeInput.value = now.toISOString().slice(0, 16);
        navigator.geolocation.getCurrentPosition((location) => {
            console.log(location.coords.latitude);
            latitudeInput.value = location.coords.latitude; //纬度
            longitudeInput.value = location.coords.longitude; //经度
        });
    }
    updateInfo();
    const cancleHandle = setInterval(updateInfo, 60 * 1000);


    async function preview(file) {
        if (file.files.length > 9) {
            //TODO: 完善提醒
            alert("Too much img! max 9 imgs in one time");
            return;
        }
        const prevDiv = document.getElementById('preview');
        prevDiv.innerHTML = "";
        let count = 0;
        let reader = new FileReader();
        reader.onload = function (evt) {
            prevDiv.innerHTML += '<img src="' + evt.target.result +
                '" class="rounded float-left md-2 mt-2 ml-3 img-thumbnail w-25" />'; //w-25, style="width:100%"
        }
        reader.onloadend = function () {
            if (++count < file.files.length) {
                reader.readAsDataURL(file.files[count]);
            }
        }
        reader.readAsDataURL(file.files[count]);
    }

    async function SubmitSlice() {
        const B = new AnimeButton("AddSlice-Button");
        const Closer = B.OnLoding("disabled", "Submitting...");

        imgInput = document.getElementById("images");
        let Imgjson = undefined
        if (imgInput.files.length > 0) {
            //Upload Img
            let imgs = new FormData()
            for (const img of imgInput.files) {
                imgs.append('images', img);
            }
            Imgjson = await FileRequest('POST', '/image', imgs);

            if (Imgjson.State == "Success") {
                //Nothing but continue
            } else {
                Closer();
                B.Alert("btn-warning btn ml-1 mt-2", Imgjson.Msg, 3000);
                return;
            }
        }
        let formData = new FormData(document.getElementById("AddSlice-Form"));
        formData.append("Operator", Cookies.Phone);
        formData.delete("imgs");
        formData.append("LineName", "kkxx");
        let Data = formData.ToArray();
        if (imgInput.files.length > 0) {
            Data.Gallery = Imgjson.Hashs;
        } else {
            Data.Gallery = [];
        }
        const Slicejson = await JsonRequest('POST', '/api/AddSlice', Data);
        if (Slicejson.State == "Success") {
            Closer();
        } else {
            Closer();
            B.Alert("btn-warning btn ml-1 mt-2", Slicejson.Msg, 3000);
        }
    }
</script>